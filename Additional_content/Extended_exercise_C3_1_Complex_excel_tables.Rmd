---
title: "Extended exercise XXX: Dealing with complex excel table structures"
output:
  html_document: 
    theme: united
    highlight: textmate
    toc: yes
    toc_float: yes
    number_sections: true
---

```{r, echo=FALSE, eval=FALSE}
htmltools::img(src = knitr::image_uri("./Images/LATree.PNG"),
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; width:200px;')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readxl)
library(openxlsx)
library(httr)
```
***

It is likely that some data will be presented in excel sheets (`.xls` or
`.xlsx`) rather than in the `.csv` format. Often, such "presentable Excel files"
are used as appendices to official statistics, or even as part of analytical
pipelines (import or export data). These will be tables that are probably
focused on being "human legible", and rightly or wrongly are often laid out and
presented in a way that moves away from simple tables of numbers with a single
column header.For example, they can have the added complexity of having multiple
sheets, contain multiple footnotes or header lines, blank rows or columns, etc.
Because of this added formatting, they are often not the easiest to work with
using R. While it is entirely possible to convert Excel files to (for example)
simpler `.csv` files before loading them into R, this is bad practice as this
process is error-prone and leads to numerous versions of the same file.

As introduced in <mark>Section XXX of Chapter X </mark>, there are a range of
options in R to load Excel data files directly. This exercise builds on the
material and techniques presented earlier. We will explore how to load a files
from a url, read different sheets, write new excel files, and handle more
sophisticated formatting.

We will provide example answers but it is encouraged you come up with your own.

To work through the exercise, please create a new R script in a suitable place
in your working environment, and save it with a meaningful name.

# Loading a file from the web
We will first access the data. We have previously shown how to use function
`read_excel` from package <mark>readxl</mark> to load data from a local file. In
this case we will get the Consumer Price Inflation data from the Office for
National Statistics website. We will use the package `httr` see the
documentation [here](https://httr.r-lib.org/).

```{r, eval = F}
cpi_excel_url <- 'https://www.ons.gov.uk/file?uri=/economy/inflationandpriceindices/datasets/consumerpriceinflation/current/consumerpriceinflationdetailedreferencetables.xls'

httr::GET(cpi_excel_url, write_disk(cpi_excel <- tempfile(fileext = ".xls")))
```

This code will create a temporary file on your machine for the data. This is
helpful when you are not sure if you want to keep the whole file indefinitely as
temporary files will be deleted when the computer session ends.

# Iterating over multiple worksheets in a workbook
Now we have the data  we want to explore what sheets this excel file contains. 

### Exercise{.tabset .tabset-fade}

#### **Exercise** {-}

1. Try looking at the sheet names for this file.
2. Load all the sheets in a workbook into a list of data frames

**HINT: Look at the [readxl workflows](https://readxl.tidyverse.org/articles/readxl-workflows.html) page**

***

<br>


#### **Show Answer** {-}

```{r, eval = F}
# This part of the code will tell us what the names of the sheets are
readxl::excel_sheets(cpi_excel)

# This part will look at all the sheets and load them as dataframes in a list
cpi_df <- cpi_excel %>% 
          excel_sheets() %>% 
          set_names() %>% 
          map(read_excel, path = cpi_excel)
```
<br>

### {-}

You will have seen that the output you get in the console says "New names:" a 
number of times. This is because the tables within each worksheet don't have 
recognisable headers.

# Writing a new excel file

Now that we have all the sheets loaded as dataframes, we identify that we need
"Table 13" and "Table 15" sheets and we would like to create a new excel file 
only containing those sheets.

### Exercise{.tabset .tabset-fade}
#### **Exercise** {-}

1. Isolate "Table 13" and "Table 15"
2. Create a new excel file in your `Data/` directory with two sheets, one for 
each table.

**HINT: Use**

***

<br>


#### **Show Answer** {-}

```{r, eval = F}

# There are several ways you could have got the sheets you needed.
# 1. Reading the specific sheet using the `sheet =` arguments in `readxl::read_excel`
cpi_table13 <- readxl::read_excel(cpi_excel, sheet = "Table 13")
cpi_table15 <- readxl::read_excel(cpi_excel, sheet = "Table 15")

# 2. Finding the correct dataframe in your list of dataframes made earlier
cpi_table13 <- cpi_df[14]
cpi_table15 <- cpi_df[16]

# Write a new excel file with two sheets
dataset_names <- list('Sheet1' = cpi_table13, 'Sheet2' = cpi_table15)
openxlsx::write.xlsx(dataset_names, './Data/CPI_refTables.xlsx')
```
<br>

### {-}




```{r, eval = F}


```



